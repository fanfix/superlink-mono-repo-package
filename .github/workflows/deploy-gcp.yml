name: Trigger GCP Cloud Build

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - '.gitattributes'
      - 'DEPLOYMENT.md'
      - '.github/**'
  workflow_dispatch:

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      admin: ${{ steps.filter.outputs.admin }}
      agency: ${{ steps.filter.outputs.agency }}
      client: ${{ steps.filter.outputs.client }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Detect changed paths
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            admin:
              - 'apps/admin/**'
              - 'packages/design-system/**'
            agency:
              - 'apps/agency/**'
              - 'packages/design-system/**'
            client:
              - 'apps/client/**'
              - 'packages/design-system/**'

  notify-cloud-build:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.admin == 'true' ||
      needs.detect-changes.outputs.agency == 'true' ||
      needs.detect-changes.outputs.client == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Cloud Build Auto-Trigger
        run: |
          echo "âœ… GitHub push event detected"
          echo "ðŸ“¦ Changed services:"
          echo "   - Admin: ${{ needs.detect-changes.outputs.admin }}"
          echo "   - Agency: ${{ needs.detect-changes.outputs.agency }}"
          echo "   - Client: ${{ needs.detect-changes.outputs.client }}"
          echo ""
          echo "ðŸš€ GCP Cloud Build triggers are configured to auto-trigger on push"
          echo "ðŸ“Š Check build status at: https://console.cloud.google.com/cloud-build/builds"
          echo ""
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "âœ… GitHub Actions check passed - Cloud Build will handle deployment"
